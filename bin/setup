#!/usr/bin/env ruby

require "pathname"
path = Pathname.new(__FILE__)
$LOAD_PATH.unshift File.expand_path "../../bundle", path.realpath
$LOAD_PATH.unshift File.expand_path "../../lib", path

require "bundler/setup"
require "wb"

def create_tables
  # create the tables unless they already exist
  [WelcomeBot::Contributors, WelcomeBot::Reporters].each do |table|
    WelcomeBot::DynamoDB.run_migration(table)
  end
end

def add_users_to_table(users, db)
  users.each_pair do |user, vals|
    WelcomeBot::DynamoDB.add_record(db, { username: user, interaction_date: vals["created_at"] , url: vals["url"] })
  end
end

puts "\nWelcomeBot Setup\n\nThis will create the DynamoDB tables WelcomeBot_Contributors & WelcomeBot_Reporters and populate them with all\nusers that have opened issues or PRs against repositories if the Github org #{WelcomeBot::Config.github_org}.\n\nPress any key to continue"
gets # causes a pause

create_tables

pr_users = WelcomeBot::Github.fetch_issues("pull_request")
issue_users = WelcomeBot::Github.fetch_issues("issue")

add_users_to_table(pr_users, WelcomeBot::Contributors)
add_users_to_table(issue_users, WelcomeBot::Reporters)
